<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AI ç”Ÿå›¾å¡ç‰‡ç”Ÿæˆå™¨ (æ ·å¼ç²¾ä¿®ç‰ˆ)</title>
<style>
  /* =========================================
     1. å…¨å±€è®¾ç½® & å¸ƒå±€
     ========================================= */
  * { box-sizing: border-box; }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background-color: #f3f4f6; color: #333;
    overflow: hidden;
  }
  .app-container {
    display: flex; height: 100%; width: 100%; overflow: hidden;
  }

  /* =========================================
     2. å·¦ä¾§ç¼–è¾‘åŒº
     ========================================= */
  .editor-pane {
    width: 480px; background: white; border-right: 1px solid #e5e7eb;
    display: flex; flex-direction: column; z-index: 10;
    box-shadow: 4px 0 10px rgba(0,0,0,0.05); flex-shrink: 0;
  }

  .editor-header {
    padding: 15px 20px; border-bottom: 1px solid #eee; background: #fff;
    flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; z-index: 20;
  }

  .header-top { display: flex; justify-content: space-between; align-items: center; }
  .header-top h2 { margin: 0; font-size: 18px; color: #8b5cf6; }
  .data-controls { display: flex; gap: 8px; flex-wrap: wrap; }

  /* JSON ç¼–è¾‘å™¨ */
  #json-editor-container {
    display: none; margin-top: 10px; background: #fff;
    border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  #json-input {
    width: 100%; height: 200px; font-family: "Monaco", "Menlo", "Consolas", monospace;
    font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 8px;
    resize: vertical; background-color: #f8fafc; color: #334155;
  }
  .json-actions { display: flex; justify-content: space-between; margin-top: 8px; }

  .editor-scroll {
    flex: 1; overflow-y: auto; padding: 20px;
    background-color: #f9fafb; scroll-behavior: smooth;
    padding-bottom: 150px;
  }

  /* --- å¡ç‰‡å— --- */
  .editor-block {
    background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;
    padding: 15px; margin-bottom: 15px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative;
  }

  .editor-block-header {
    display: flex; justify-content: space-between; align-items: center;
    position: sticky; top: 0; z-index: 10;
    margin: -15px -15px 15px -15px; padding: 12px 15px;
    background-color: #f5f3ff; border-bottom: 1px solid #ddd6fe;
    border-radius: 8px 8px 0 0;
  }

  .block-title { 
    font-size: 14px; font-weight: bold; color: #7c3aed; 
    flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    min-width: 0; margin-right: 10px;
  }

  /* æ“ä½œæŒ‰é’® */
  .block-actions { display: flex; gap: 6px; }
  .btn-icon { 
    padding: 2px 8px; border: 1px solid #d1d5db; background: white; 
    border-radius: 4px; cursor: pointer; color: #666; font-size: 12px;
    height: 26px; display: inline-flex; align-items: center; justify-content: center;
  }
  .btn-icon:hover { background: #f3f4f6; color: #3b82f6; border-color: #93c5fd; }
  .btn-move { color: #6b7280; font-weight: bold; }
  .btn-del-block { color: #ef4444; border-color: #fca5a5; }
  .btn-del-block:hover { background: #fee2e2; color: #dc2626; border-color: #f87171; }

  .form-group { margin-bottom: 12px; position: relative; }
  .form-row { display: flex; gap: 10px; }
  .form-label { display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 600; }
  
  .form-input, .form-textarea {
    width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;
    font-size: 13px; font-family: inherit; background-color: #fff;
  }
  .form-input:focus, .form-textarea:focus {
    border-color: #8b5cf6; outline: none; box-shadow: 0 0 0 2px rgba(139,92,246,0.1);
  }
  .form-textarea { resize: vertical; min-height: 60px; }

  /* æç¤ºè¯ç»„ç¼–è¾‘å™¨ */
  .prompt-group-editor {
    border: 1px solid #e5e7eb; background-color: #f9fafb; border-radius: 6px;
    padding: 10px; margin-bottom: 10px; position: relative;
  }
  .prompt-group-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; 
  }
  .prompt-title-wrapper { display: flex; align-items: center; gap: 8px; flex: 1; }
  .badge-index { 
    background: #e5e7eb; padding: 4px 6px; border-radius: 4px; 
    color: #666; font-size: 11px; font-weight: bold; flex-shrink: 0;
  }
  .input-prompt-title {
    padding: 4px 8px; font-size: 12px; border: 1px solid #d1d5db; 
    border-radius: 4px; width: 180px; background: #fff;
  }
  .input-prompt-title:focus { border-color: #8b5cf6; outline: none; }

  /* å›¾ç‰‡åˆ—è¡¨ */
  .img-list-container { border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px; background: #fff; }
  .img-input-row { display: flex; gap: 6px; margin-bottom: 6px; }
  .img-input-row:last-child { margin-bottom: 0; }
  .btn-add-img {
    width: 100%; padding: 4px; border: 1px dashed #d1d5db; background: white; color: #666; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 4px;
  }
  .btn-add-img:hover { border-color: #8b5cf6; color: #8b5cf6; background: #f5f3ff; }

  /* ä¸‹æ‹‰èœå• */
  .suggestions-list {
    position: absolute; top: 100%; left: 0; right: 0;
    background: white; border: 1px solid #d1d5db; border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 250px;
    overflow-y: auto; z-index: 100; display: none; margin-top: 4px;
  }
  .suggestion-category {
    padding: 6px 10px; background-color: #f3f4f6; color: #6b7280;
    font-size: 11px; font-weight: bold; border-bottom: 1px solid #e5e7eb;
  }
  .suggestion-item {
    padding: 8px 10px; font-size: 13px; cursor: pointer;
    border-bottom: 1px solid #f9fafb; color: #333;
  }
  .suggestion-item:hover { background-color: #eff6ff; color: #3b82f6; }
  .suggestion-item:last-child { border-bottom: none; }

  /* =========================================
     3. å³ä¾§é¢„è§ˆåŒº
     ========================================= */
  .preview-pane {
    flex: 1; background-color: #e5e7eb;
    display: flex; flex-direction: column; align-items: center;
    padding: 20px; overflow-y: auto; overflow-x: hidden;
    position: relative; scroll-behavior: smooth; width: 100%;
  }
  .preview-header-bar {
    width: 100%; max-width: 450px; display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 15px; flex-shrink: 0;
  }
  .mobile-frame { width: 100%; max-width: 450px; padding-bottom: 50px; }

  /* æ ‡é¢˜æ±‡æ€» */
  .title-summary-card {
    background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 12px;
    margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); width: 100%;
  }
  .title-summary-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px;
  }
  .title-summary-label { font-size: 12px; font-weight: bold; color: #6b7280; }
  .title-count-badge { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: #374151; }
  .title-summary-content { font-size: 14px; color: #374151; line-height: 1.6; word-break: break-all; }
  .btn-sm-copy {
    font-size: 11px; padding: 2px 8px; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; background: white;
  }
  .btn-sm-copy:hover { border-color: #8b5cf6; color: #8b5cf6; background: #f5f3ff; }

  /* =========================================
     4. æŒ‰é’® & å“åº”å¼
     ========================================= */
  .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; white-space: nowrap;}
  .btn-primary { background: #8b5cf6; color: white; }
  .btn-primary:hover { background: #7c3aed; }
  .btn-outline { background: white; border: 1px solid #d1d5db; color: #374151; }
  .btn-outline:hover { background: #f9fafb; border-color: #9ca3af; }
  .btn-delete { color: #ef4444; background: white; border: 1px solid #fecaca; padding: 4px 10px; border-radius: 4px; font-size: 12px; }
  .btn-delete:hover { background: #fee2e2; }
  .btn-add { background: #10b981; color: white; width: 100%; margin-top: 10px; padding: 10px; }
  .btn-json { background: #374151; color: white; }
  .btn-json:hover { background: #1f2937; }
  .btn-csv { background: #059669; color: white; }
  .btn-csv:hover { background: #047857; }
  .btn-add-group { background: #fff; border: 1px dashed #8b5cf6; color: #8b5cf6; width: 100%; margin-top: 5px; }
  .btn-add-group:hover { background: #f5f3ff; }

  @media (max-width: 768px) {
    .app-container { flex-direction: column; }
    .editor-pane { width: 100%; height: 50%; border-right: none; border-bottom: 1px solid #d1d5db; }
    .preview-pane { width: 100%; height: 50%; padding: 15px 10px; align-items: stretch; }
    .editor-scroll { padding: 15px; padding-bottom: 100px; }
    .mobile-frame, .preview-header-bar { max-width: 100%; margin: 0 auto; }
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="editor-pane">
    <div class="editor-header">
      <div class="header-top">
        <h2>AI å¡ç‰‡ç”Ÿæˆå™¨</h2>
        <button class="btn btn-primary" onclick="addCard()">+ æ–°å»º</button>
      </div>
      <div class="data-controls">
        <button class="btn btn-json" onclick="toggleJsonEditor()">JSON ç¼–è¾‘</button>
        <button class="btn btn-outline" onclick="exportData()">â¬‡ å¯¼å‡º</button>
        <button class="btn btn-outline" onclick="triggerImport('json')">â¬† å¯¼å…¥JSON</button>
        <button class="btn btn-csv" onclick="triggerImport('csv')">ğŸ“„ å¯¼å…¥CSV</button>
        
        <input type="file" id="fileInputJson" accept=".json" style="display: none;" onchange="handleFileImport(this, 'json')">
        <input type="file" id="fileInputCsv" accept=".csv" style="display: none;" onchange="handleFileImport(this, 'csv')">
      </div>

      <div id="json-editor-container">
        <div style="margin-bottom: 5px; font-size:12px; color:#666;">
          ä¿®æ”¹ JSON åç‚¹å‡»åº”ç”¨ã€‚æ–°æ¨¡å‹ä¼šè‡ªåŠ¨å­¦ä¹ ã€‚
        </div>
        <textarea id="json-input" placeholder="åœ¨æ­¤ç²˜è´´ JSON æ•°æ®..."></textarea>
        <div class="json-actions">
           <button class="btn btn-outline" onclick="copyJsonContent()">å¤åˆ¶ JSON</button>
           <div style="display:flex; gap:5px;">
             <button class="btn btn-outline" onclick="resetModels()">é‡ç½®æ¨¡å‹</button>
             <button class="btn btn-primary" onclick="applyJsonChange()">åº”ç”¨æ›´æ”¹</button>
           </div>
        </div>
      </div>
    </div>

    <div class="editor-scroll" id="editorScroll">
      <div id="editor-list"></div>
      <button class="btn btn-add" onclick="addCard()">+ æ·»åŠ æ–°å¡ç‰‡</button>
    </div>
  </div>

  <div class="preview-pane" id="previewPane">
    <div class="preview-header-bar">
      <span style="font-size:12px; font-weight:bold; color:#666;">PREVIEW</span>
      <button class="btn btn-primary" onclick="copyForWechat()">å¤åˆ¶åˆ°å…¬ä¼—å·</button>
    </div>
    
    <div class="mobile-frame">
      <div class="title-summary-card">
        <div class="title-summary-header">
          <span class="title-summary-label">æ ‡é¢˜æ±‡æ€» <span id="title-count" class="title-count-badge">0å­—</span></span>
          <button class="btn-sm-copy" onclick="copyTitles()">å¤åˆ¶æ ‡é¢˜</button>
        </div>
        <div class="title-summary-content" id="title-summary-text"></div>
      </div>

      <div id="preview-list"></div>
    </div>
    <div style="height: 50px;"></div>
  </div>
</div>

<script>
  // ==========================================
  // 0. æ¨¡å‹æ•°æ®åº“
  // ==========================================
  const STORAGE_KEY_MODELS = 'ai_card_tool_models_v2';
  const DEFAULT_MODEL_DATA = [
    { category: "ğŸ”¥ å›½äº§çƒ­é—¨", items: ["Kling (å¯çµ)", "Hailuo (æµ·èº/Minimax)", "Vidu (å³æ¢¦)", "Kolors (å¯å›¾)", "CogVideoX (æ™ºè°±)", "Hunyuan (è…¾è®¯æ··å…ƒ)", "Tongyi Wanxiang (é€šä¹‰ä¸‡ç›¸)"] },
    { category: "ğŸŒ å…¨çƒç”Ÿå›¾", items: ["FLUX.1 [dev]", "FLUX.1 [schnell]", "Midjourney V6.1", "Midjourney V6", "Stable Diffusion 3.5 Large", "Ideogram 2.0", "DALLÂ·E 3"] },
    { category: "ğŸ¬ å…¨çƒç”Ÿè§†é¢‘", items: ["Runway Gen-3 Alpha", "Luma Dream Machine", "Pika 1.5", "Sora (Preview)"] }
  ];
  let currentModelData = [];

  function initModels() {
    const stored = localStorage.getItem(STORAGE_KEY_MODELS);
    currentModelData = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(DEFAULT_MODEL_DATA));
  }

  function extractAndSaveModels(cards) {
    const existingSet = new Set();
    currentModelData.forEach(g => g.items.forEach(m => existingSet.add(m)));
    const newModels = [];
    cards.forEach(c => {
      if (c.model && c.model.trim() !== "" && !existingSet.has(c.model)) {
        newModels.push(c.model);
        existingSet.add(c.model);
      }
    });
    if (newModels.length > 0) {
      if (currentModelData.length === 0 || currentModelData[0].category !== "ğŸ†• æ–°å¢/è‡ªå®šä¹‰") {
        currentModelData.unshift({ category: "ğŸ†• æ–°å¢/è‡ªå®šä¹‰", items: [] });
      }
      currentModelData[0].items.unshift(...newModels);
      localStorage.setItem(STORAGE_KEY_MODELS, JSON.stringify(currentModelData));
    }
  }

  function resetModels() {
    if(confirm("é‡ç½®æ¨¡å‹åˆ—è¡¨ï¼Ÿ")) {
      currentModelData = JSON.parse(JSON.stringify(DEFAULT_MODEL_DATA));
      localStorage.removeItem(STORAGE_KEY_MODELS);
      renderEditors();
    }
  }

  // ==========================================
  // 1. è¡Œé—´æ ·å¼é…ç½® (ç»Ÿä¸€é—´è·ä¼˜åŒ–ç‰ˆ)
  // ==========================================
  const STYLES = {
    // åº•éƒ¨é—´è·åŠ å¤§åˆ° 30pxï¼Œä½œä¸ºå¡ç‰‡ä¹‹é—´çš„é—´éš”
    card: `background:#ffffff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #e0e0e0;width:100%;margin-bottom:30px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;padding:15px;box-sizing:border-box;overflow:hidden;`,
    
    // ç»Ÿä¸€å„æ¨¡å—é—´è·ä¸º 10px-12px
    title: `font-size:17px;font-weight:700;color:#1f2937;margin:0 0 8px 0;line-height:1.4;`,
    intro: `font-size:14px;color:#6b7280;margin:0 0 10px 0;line-height:1.6;text-align:justify;`,
    
    metaSection: `margin-bottom:10px;font-size:0;`, 
    modelTag: `background-color:#f5f3ff;color:#8b5cf6;padding:4px 8px;border-radius:4px;font-weight:600;font-size:12px;display:inline-block;border:1px solid #ddd6fe;line-height:1;margin-right:8px;vertical-align:middle;`,
    sourceTag: `background-color:#f3f4f6;color:#6b7280;padding:4px 8px;border-radius:4px;font-weight:500;font-size:12px;display:inline-block;border:1px solid #e5e7eb;line-height:1;vertical-align:middle;`,
    
    // æ¯ä¸ª Prompt Group ä¹‹é—´çš„é—´è·
    // åªæœ‰ç¬¬ä¸€ç»„ä¹‹åçš„ç»„æ‰ä¼šæœ‰ border-topï¼Œä»£ç é‡ŒåŠ¨æ€æ§åˆ¶
    promptBlock: `margin-bottom:10px;padding-top:10px;`,
    
    // æç¤ºè¯æ–‡æœ¬ä¸ä¸‹æ–¹å›¾ç‰‡çš„é—´è·ï¼š10px
    promptSection: `background-color:#fafafa;padding:10px;border-radius:6px;margin-bottom:10px;border-left:3px solid #8b5cf6;`,
    promptLabel: `font-size:12px;color:#a78bfa;margin-bottom:4px;font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;`,
    promptText: `font-size:14px;color:#374151;line-height:1.5;margin:0;word-break:break-word;`,
    
    // å›¾ç‰‡è¡¨æ ¼å¸ƒå±€
    imgTable: `width:100%;border-collapse:collapse;border:0;table-layout:fixed;`,
    // ä¸­é—´é—´è·è°ƒæ•´ä¸º 8px (çº¦2%)ï¼Œå·¦å³å„ 49%
    imgTdLeft: `width:49%;vertical-align:top;padding:0;border:0;`,
    imgTdGap: `width:8px;padding:0;border:0;`,
    imgTdRight: `width:49%;vertical-align:top;padding:0;border:0;`,
    
    mediaLabel: `font-size:12px;color:#9ca3af;margin-bottom:6px;text-align:center;display:block;font-weight:500;`,
    
    // çºµå‘å›¾ç‰‡é—´è·ç»Ÿä¸€ä¸º 10px
    mediaContent: `width:100%;height:auto;border-radius:6px;background-color:#f3f4f6;border:1px solid #e5e7eb;display:block;margin-bottom:10px;`
  };

  function s(str) { return str.replace(/\s+/g, ' ').trim(); }

  // åˆå§‹æ•°æ®
  let cards = [
    {
      id: Date.now(),
      title: "ç¤ºä¾‹å¡ç‰‡",
      intro: "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼ŒåŒ…å«å¤šç»„æç¤ºè¯ã€‚",
      model: "Kling (å¯çµ)",
      source: "å®˜æ–¹ç¤ºä¾‹",
      promptList: [
        { title: "å›¾ç‰‡æç¤ºè¯", text: "Futuristic city street level...", refImgs: [], genImgs: [] },
        { title: "è§†é¢‘æç¤ºè¯", text: "Camera pan up...", refImgs: [], genImgs: [] }
      ]
    }
  ];

  function init() {
    initModels();
    renderEditors();
    renderPreviews();
    initSyncScroll();
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.form-group')) { closeAllSuggestions(); }
    });
  }

  // ==========================================
  // ç¼–è¾‘å™¨é€»è¾‘
  // ==========================================
  function renderEditors() {
    const container = document.getElementById('editor-list');
    container.innerHTML = '';
    cards.forEach((card, index) => {
      const block = document.createElement('div');
      block.className = 'editor-block';
      
      block.innerHTML = `
        <div class="editor-block-header">
          <span class="block-title" title="${escapeHtml(card.title)}">#${index + 1} ${escapeHtml(card.title || 'æœªå‘½å')}</span>
          <div class="block-actions">
            ${index > 0 ? `<button class="btn-icon btn-move" onclick="moveCardUp(${index})" title="ä¸Šç§»">â†‘</button>` : ''}
            ${index < cards.length - 1 ? `<button class="btn-icon btn-move" onclick="moveCardDown(${index})" title="ä¸‹ç§»">â†“</button>` : ''}
            <button class="btn-icon btn-del-block" onclick="deleteCard(${card.id})" title="åˆ é™¤å¡ç‰‡">âœ•</button>
          </div>
        </div>
        
        <div class="form-group"><label class="form-label">æ ‡é¢˜</label><input type="text" class="form-input" value="${escapeHtml(card.title)}" oninput="updateCardField(${card.id}, 'title', this.value)"></div>
        <div class="form-group"><label class="form-label">ç®€ä»‹</label><textarea class="form-textarea" oninput="updateCardField(${card.id}, 'intro', this.value)">${escapeHtml(card.intro)}</textarea></div>
        
        <div class="form-row">
          <div class="form-group" style="flex:1">
              <label class="form-label">æ¨¡å‹</label>
              <input type="text" class="form-input model-input" value="${escapeHtml(card.model)}" 
                     oninput="updateCardField(${card.id}, 'model', this.value); filterSuggestions(this);"
                     onfocus="showSuggestions(this)" data-card-id="${card.id}">
              <div class="suggestions-list">${generateSuggestionsHtml(card.id)}</div>
          </div>
          <div class="form-group" style="flex:1">
              <label class="form-label">æ¥æº</label>
              <input type="text" class="form-input" value="${escapeHtml(card.source || '')}" oninput="updateCardField(${card.id}, 'source', this.value)">
          </div>
        </div>

        <hr style="border:0; border-top:1px dashed #e5e7eb; margin:15px 0;">
        <label class="form-label" style="margin-bottom:8px">æç¤ºè¯ç»„</label>
        
        <div id="prompt-container-${card.id}">
          ${card.promptList.map((p, pIdx) => renderPromptBlock(card.id, pIdx, p)).join('')}
        </div>
        
        <button class="btn btn-add-group" onclick="addPromptBlock(${card.id})">+ æ·»åŠ æç¤ºè¯ç»„</button>
      `;
      container.appendChild(block);
    });
  }

  function renderPromptBlock(cardId, pIdx, data) {
    return `
      <div class="prompt-group-editor">
        <div class="prompt-group-header">
          <div class="prompt-title-wrapper">
            <span class="badge-index">GROUP ${pIdx + 1}</span>
            <input type="text" class="input-prompt-title" 
                   placeholder="æ ‡é¢˜ (å¯é€‰)"
                   value="${escapeHtml(data.title || '')}"
                   oninput="updatePromptTitle(${cardId}, ${pIdx}, this.value)">
          </div>
          <button class="btn-icon" onclick="removePromptBlock(${cardId}, ${pIdx})" title="åˆ é™¤æ­¤ç»„">ğŸ—‘</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">æç¤ºè¯</label>
          <textarea class="form-textarea" style="height:60px;" 
            oninput="updatePromptText(${cardId}, ${pIdx}, this.value)">${escapeHtml(data.text)}</textarea>
        </div>

        <div class="form-row">
          <div class="form-group" style="flex:1">
             <label class="form-label">å‚è€ƒå›¾åˆ—è¡¨</label>
             <div class="img-list-container">
               <div id="ref-list-${cardId}-${pIdx}">
                 ${generateImgInputs(cardId, pIdx, 'refImgs', data.refImgs)}
               </div>
               <button class="btn-add-img" onclick="addPromptImg(${cardId}, ${pIdx}, 'refImgs')">+ åŠ é“¾æ¥</button>
             </div>
          </div>
          <div class="form-group" style="flex:1">
             <label class="form-label">ç”Ÿæˆå›¾åˆ—è¡¨</label>
             <div class="img-list-container">
               <div id="gen-list-${cardId}-${pIdx}">
                 ${generateImgInputs(cardId, pIdx, 'genImgs', data.genImgs)}
               </div>
               <button class="btn-add-img" onclick="addPromptImg(${cardId}, ${pIdx}, 'genImgs')">+ åŠ é“¾æ¥</button>
             </div>
          </div>
        </div>
      </div>
    `;
  }

  function generateImgInputs(cardId, pIdx, type, urls) {
    if (!urls || urls.length === 0) return '';
    return urls.map((url, idx) => `
      <div class="img-input-row">
        <input type="text" class="form-input" value="${escapeHtml(url)}" 
               oninput="updatePromptImgUrl(this, ${cardId}, ${pIdx}, '${type}', ${idx})" placeholder="https://...">
        <button class="btn-icon" onclick="removePromptImg(${cardId}, ${pIdx}, '${type}', ${idx})">âœ•</button>
      </div>
    `).join('');
  }

  // --- æ•°æ®æ“ä½œ ---
  function updateCardField(id, field, value) {
    const card = cards.find(c => c.id === id);
    if (card) {
      card[field] = value;
      refreshPreview(id);
      if(field === 'title') {
        renderEditors(); 
        updateTitleSummary();
      }
    }
  }
  function moveCardUp(index) {
    if (index > 0) {
      [cards[index - 1], cards[index]] = [cards[index], cards[index - 1]];
      renderEditors(); renderPreviews();
    }
  }
  function moveCardDown(index) {
    if (index < cards.length - 1) {
      [cards[index + 1], cards[index]] = [cards[index], cards[index + 1]];
      renderEditors(); renderPreviews();
    }
  }
  function addPromptBlock(cardId) {
    const card = cards.find(c => c.id === cardId);
    if (card) {
      card.promptList.push({ title: "", text: "", refImgs: [], genImgs: [] });
      renderEditors(); refreshPreview(cardId);
    }
  }
  function removePromptBlock(cardId, pIdx) {
    const card = cards.find(c => c.id === cardId);
    if (card && card.promptList.length > 1) {
      card.promptList.splice(pIdx, 1);
      renderEditors(); refreshPreview(cardId);
    } else { alert("è‡³å°‘ä¿ç•™ä¸€ç»„"); }
  }
  function updatePromptText(cardId, pIdx, val) {
    const card = cards.find(c => c.id === cardId);
    if(card) { card.promptList[pIdx].text = val; refreshPreview(cardId); }
  }
  function updatePromptTitle(cardId, pIdx, val) {
    const card = cards.find(c => c.id === cardId);
    if(card && card.promptList[pIdx]) {
      card.promptList[pIdx].title = val;
      refreshPreview(cardId);
    }
  }
  function addPromptImg(cardId, pIdx, type) {
    const card = cards.find(c => c.id === cardId);
    if(card) { card.promptList[pIdx][type].push(""); renderEditors(); refreshPreview(cardId); }
  }
  function removePromptImg(cardId, pIdx, type, imgIdx) {
    const card = cards.find(c => c.id === cardId);
    if(card) { card.promptList[pIdx][type].splice(imgIdx, 1); renderEditors(); refreshPreview(cardId); }
  }
  function updatePromptImgUrl(input, cardId, pIdx, type, imgIdx) {
    let raw = input.value;
    const match = raw.match(/(https?:\/\/[^\s)"'<>\]]+)/);
    if (match && match[0] !== raw) {
      input.value = match[0]; raw = match[0];
      input.style.backgroundColor = "#eff6ff"; setTimeout(() => input.style.backgroundColor = "#fff", 300);
    }
    const card = cards.find(c => c.id === cardId);
    if(card) { card.promptList[pIdx][type][imgIdx] = raw; refreshPreview(cardId); }
  }

  // --- é¢„è§ˆæ¸²æŸ“ ---
  function renderPreviews() {
    const container = document.getElementById('preview-list');
    container.innerHTML = '';
    updateTitleSummary();

    cards.forEach(card => {
      const wrapper = document.createElement('div');
      wrapper.id = `preview-${card.id}`;
      wrapper.innerHTML = generateInlineHtml(card);
      container.appendChild(wrapper);
    });
  }
  function refreshPreview(cardId) {
    const card = cards.find(c => c.id === cardId);
    const el = document.getElementById(`preview-${cardId}`);
    if (el && card) el.innerHTML = generateInlineHtml(card);
  }

  function generateInlineHtml(card) {
    const modelHtml = card.model ? `<span style="${s(STYLES.modelTag)}">æ¨¡å‹: ${card.model}</span>` : '';
    const sourceHtml = card.source ? `<span style="${s(STYLES.sourceTag)}">æ¥æº: ${card.source}</span>` : '';
    
    const promptBlocksHtml = card.promptList.map((block, idx) => {
      const refs = block.refImgs || [];
      const gens = block.genImgs || [];
      
      let displayTitle = block.title;
      if (!displayTitle) {
        if (card.promptList.length > 1) {
            displayTitle = `æç¤ºè¯ ${idx + 1}`;
        } else {
            displayTitle = "æç¤ºè¯";
        }
      }
      
      const generateImgBlock = (urls) => {
        if (!urls || urls.length === 0) return `<div style="height:80px;background:#f9fafb;border-radius:8px;border:1px dashed #ddd;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:12px;">æ— å›¾</div>`;
        return urls.map((url, i) => {
          // æœ€åä¸€å¼ å›¾ä¸åŠ  margin-bottom
          const style = (i === urls.length - 1) ? s(STYLES.mediaContent).replace('margin-bottom:10px;', 'margin-bottom:0;') : s(STYLES.mediaContent);
          const src = url || 'https://placehold.co/400x400/e5e7eb/gray?text=Empty';
          return `<img src="${src}" style="${style}">`;
        }).join('');
      };
      
      // ç¬¬äºŒç»„å¼€å§‹åŠ  dashed border-top
      const wrapperStyle = idx > 0 
        ? s(STYLES.promptBlock) + "border-top:1px dashed #eee; padding-top:10px;" 
        : s(STYLES.promptBlock).replace('padding-top:10px;', ''); // ç¬¬ä¸€ç»„å»é™¤ padding-top

      return `
        <div style="${wrapperStyle}">
          <section style="${s(STYLES.promptSection)}">
            <div style="${s(STYLES.promptLabel)}">${displayTitle}</div>
            <p style="${s(STYLES.promptText)}">${block.text || ''}</p>
          </section>
          <table width="100%" border="0" cellspacing="0" cellpadding="0" style="${s(STYLES.imgTable)}">
            <tr>
              <td width="48%" style="${s(STYLES.imgTdLeft)}"><span style="${s(STYLES.mediaLabel)}">å‚è€ƒå›¾</span>${generateImgBlock(refs)}</td>
              <td width="4%" style="${s(STYLES.imgTdGap)}"></td>
              <td width="48%" style="${s(STYLES.imgTdRight)}"><span style="${s(STYLES.mediaLabel)}">ç”Ÿæˆå›¾</span>${generateImgBlock(gens)}</td>
            </tr>
          </table>
        </div>
      `;
    }).join('');

    return `
<section style="${s(STYLES.card)}">
  <h3 style="${s(STYLES.title)}">${card.title || 'æ— æ ‡é¢˜'}</h3>
  <p style="${s(STYLES.intro)}">${card.intro || ''}</p>
  <section style="${s(STYLES.metaSection)}">${modelHtml}${sourceHtml}</section>
  ${promptBlocksHtml}
</section>`;
  }

  // --- æ ‡é¢˜æ±‡æ€»åŠŸèƒ½ ---
  function updateTitleSummary() {
    const titles = cards.map(c => c.title).filter(t => t && t.trim() !== "" && t !== "æœªå‘½å");
    const summaryText = titles.join("ã€");
    const count = summaryText.length;
    document.getElementById('title-summary-text').innerText = summaryText;
    document.getElementById('title-count').innerText = count + "å­—";
  }

  function copyTitles() {
    const text = document.getElementById('title-summary-text').innerText;
    navigator.clipboard.writeText(text).then(() => {
      const btn = document.querySelector('.btn-sm-copy');
      const originalText = btn.innerText;
      btn.innerText = "å·²å¤åˆ¶";
      btn.style.background = "#e5e7eb";
      setTimeout(() => { btn.innerText = originalText; btn.style.background = "white"; }, 1500);
    });
  }

  // --- CSV Parser ---
  function parseCSV(text) {
    const rows = []; let currentRow = []; let currentField = ''; let insideQuote = false;
    for (let i = 0; i < text.length; i++) {
        const char = text[i]; const nextChar = text[i+1];
        if (insideQuote) {
            if (char === '"') {
                if (nextChar === '"') { currentField += '"'; i++; } else { insideQuote = false; }
            } else { currentField += char; }
        } else {
            if (char === '"') { insideQuote = true; } 
            else if (char === ',') { currentRow.push(currentField); currentField = ''; } 
            else if (char === '\n' || char === '\r') {
                if (char === '\r' && nextChar === '\n') i++;
                currentRow.push(currentField); rows.push(currentRow); currentRow = []; currentField = '';
            } else { currentField += char; }
        }
    }
    if (currentField || currentRow.length > 0) { currentRow.push(currentField); rows.push(currentRow); }
    return rows;
  }

  function handleFileImport(input, type) {
    const file = input.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      if (type === 'json') {
        try {
          const json = JSON.parse(e.target.result);
          applyDataImport(json);
        } catch(err) { alert("JSON è§£æå¤±è´¥"); }
      } else if (type === 'csv') {
        try {
          const rows = parseCSV(e.target.result);
          if (rows.length < 2) { alert("CSV åªæœ‰æ ‡é¢˜è¡Œæˆ–ä¸ºç©º"); return; }
          const headers = rows[0].map(h => h.trim());
          const idx = {
            title: headers.indexOf('æ ‡é¢˜'),
            prompt: headers.indexOf('æç¤ºè¯'),
            intro: headers.indexOf('ç®€ä»‹'),
            model: headers.indexOf('æ¨¡å‹'),
            source: headers.indexOf('æ¥æº'),
            status: headers.indexOf('çŠ¶æ€')
          };
          
          if (idx.title === -1 || idx.prompt === -1 || idx.status === -1) {
            alert("CSV ç¼ºå°‘å…³é”®åˆ— (æ ‡é¢˜, æç¤ºè¯, çŠ¶æ€)"); return;
          }

          const newCards = [];
          const baseTime = Date.now();

          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (row.length < headers.length) continue;
            if (row[idx.status].trim() !== 'å·²å®Œæˆ') continue;

            const promptRaw = row[idx.prompt] || "";
            const regex = /(?:^|[ã€‘ï¼›;])\s*([^ã€]*?)ã€(.*?)ã€‘/g;
            const matches = [...promptRaw.matchAll(regex)];
            
            let pList = [];
            if (matches.length > 0) {
              pList = matches.map(m => {
                let t = m[1].trim();
                t = t.replace(/^[:ï¼š,ï¼Œ;ï¼›\s]+/, '');
                return { title: t, text: m[2], refImgs: [], genImgs: [] };
              });
            } else {
              if (promptRaw.trim()) pList = [{ title: "", text: promptRaw, refImgs: [], genImgs: [] }];
              else pList = [{ title: "", text: "", refImgs: [], genImgs: [] }];
            }

            newCards.push({
              id: baseTime + i,
              title: row[idx.title] || "æœªå‘½å",
              intro: idx.intro > -1 ? (row[idx.intro] || "") : "",
              model: idx.model > -1 ? (row[idx.model] || "") : "",
              source: idx.source > -1 ? (row[idx.source] || "") : "",
              promptList: pList
            });
          }

          if (newCards.length === 0) { alert("æ²¡æœ‰æ‰¾åˆ°å·²å®Œæˆæ•°æ®"); return; }
          if(confirm(`è§£ææˆåŠŸï¼å‡†å¤‡å¯¼å…¥ ${newCards.length} æ¡æ•°æ®ï¼Ÿ`)) {
            extractAndSaveModels(newCards);
            cards = newCards;
            renderEditors(); renderPreviews();
          }
        } catch(err) { console.error(err); alert("CSV è§£æé”™è¯¯"); }
      }
    };
    reader.readAsText(file); input.value = '';
  }

  // --- é€šç”¨é€»è¾‘ ---
  function applyDataImport(importedData) {
    if (!Array.isArray(importedData)) { alert("æ ¼å¼é”™è¯¯"); return; }
    if(confirm(`ç¡®å®šå¯¼å…¥ ${importedData.length} æ¡æ•°æ®ï¼Ÿ`)) {
      extractAndSaveModels(importedData);
      const baseTimestamp = Date.now();
      cards = importedData.map((card, index) => {
        let pList = card.promptList;
        // å…¼å®¹æ—§ç‰ˆé€»è¾‘
        if (!pList) {
          let oldRef = card.refImgs || (card.refImg ? [card.refImg] : []);
          let oldGen = card.genImgs || (card.genImg ? [card.genImg] : []);
          pList = [{ title: "", text: card.prompt || "", refImgs: oldRef, genImgs: oldGen }];
        }
        return { ...card, id: baseTimestamp + index, promptList: pList };
      });
      renderEditors(); renderPreviews();
    }
  }

  function triggerImport(type) {
    if(type === 'json') document.getElementById('fileInputJson').click();
    else document.getElementById('fileInputCsv').click();
  }

  // æ¨¡å‹é€‰æ‹©å™¨ç›¸å…³
  function generateSuggestionsHtml(cardId) {
    let html = '';
    currentModelData.forEach(group => {
      html += `<div class="suggestion-category">${group.category}</div>`;
      group.items.forEach(item => {
        html += `<div class="suggestion-item" onclick="selectSuggestion(${cardId}, '${item.replace(/'/g, "\\'")}')">${item}</div>`;
      });
    });
    return html;
  }
  function showSuggestions(inputEl) {
    closeAllSuggestions(); inputEl.nextElementSibling.style.display = 'block';
    inputEl.nextElementSibling.querySelectorAll('.suggestion-item, .suggestion-category').forEach(i => i.style.display = 'block');
  }
  function filterSuggestions(inputEl) {
    const filter = inputEl.value.toLowerCase();
    const items = inputEl.nextElementSibling.querySelectorAll('.suggestion-item');
    items.forEach(item => item.style.display = item.innerText.toLowerCase().includes(filter) ? 'block' : 'none');
  }
  function selectSuggestion(cardId, value) {
    updateCardField(cardId, 'model', value);
    renderEditors(); 
  }
  function closeAllSuggestions() { document.querySelectorAll('.suggestions-list').forEach(el => el.style.display = 'none'); }

  // JSONç¼–è¾‘å™¨
  function toggleJsonEditor() {
    const el = document.getElementById('json-editor-container');
    if(el.style.display==='block') el.style.display='none'; else { el.style.display='block'; updateJsonBoxFromData(); }
  }
  function updateJsonBoxFromData() {
    const cleanData = cards.map(({ id, ...rest }) => rest);
    document.getElementById('json-input').value = JSON.stringify(cleanData, null, 2);
  }
  function copyJsonContent() { navigator.clipboard.writeText(document.getElementById('json-input').value).then(()=>alert("å·²å¤åˆ¶")); }
  function applyJsonChange() {
    try { const parsed = JSON.parse(document.getElementById('json-input').value); applyDataImport(parsed); document.getElementById('json-editor-container').style.display='none'; } catch(e) { alert("JSON Error"); }
  }

  function addCard() {
    cards.push({ id: Date.now(), title: "æ–°ä½œå“", intro: "...", model: "Kling", source: "", promptList: [{ title:"", text: "", refImgs: [], genImgs: [] }] });
    renderEditors(); renderPreviews();
  }
  function deleteCard(id) {
    if (confirm("åˆ é™¤ï¼Ÿ")) { cards = cards.filter(c => c.id !== id); renderEditors(); renderPreviews(); }
  }
  function exportData() {
    const cleanData = cards.map(({ id, ...rest }) => rest);
    const blob = new Blob([JSON.stringify(cleanData, null, 2)], { type: "application/json" });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `card_config.json`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }
  function copyForWechat() {
    const container = document.getElementById('preview-list');
    const range = document.createRange(); range.selectNode(container);
    const selection = window.getSelection(); selection.removeAllRanges(); selection.addRange(range);
    const listener = function(e) {
      e.preventDefault(); if (e.clipboardData) {
        // ä½¿ç”¨æ­£åˆ™å»é™¤å¤šä½™çš„æ¢è¡Œç¬¦ï¼Œé˜²æ­¢å¡ç‰‡é—´è·è¿‡å¤§
        let html = container.innerHTML;
        // å»é™¤ç©ºè¡Œæ ‡ç­¾
        html = html.replace(/<br\s*\/?>/gi, '');
        e.clipboardData.setData('text/html', html);
        e.clipboardData.setData('text/plain', container.innerText);
      }
    };
    document.addEventListener('copy', listener);
    try { document.execCommand('copy'); alert("å¤åˆ¶æˆåŠŸï¼"); } catch (err) { alert("å¤åˆ¶å¤±è´¥"); } finally { document.removeEventListener('copy', listener); }
  }
  function initSyncScroll() {
    const e = document.getElementById('editorScroll'), p = document.getElementById('previewPane');
    let l = false, r = false;
    e.addEventListener('scroll', function() { if (!l) { r = true; p.scrollTop = (this.scrollTop / (this.scrollHeight - this.clientHeight)) * (p.scrollHeight - p.clientHeight); } l = false; });
    p.addEventListener('scroll', function() { if (!r) { l = true; e.scrollTop = (this.scrollTop / (this.scrollHeight - this.clientHeight)) * (e.scrollHeight - e.clientHeight); } r = false; });
  }
  function escapeHtml(t) { if (!t) return ""; return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

  init();
</script>
</body>
</html>